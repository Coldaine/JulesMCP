version: '3.8'

# Shared network for multi-service architecture
# Allows JulesMCP to communicate with LLM router and other MCP servers
networks:
  mcp-network:
    driver: bridge
    name: mcp-network

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jules-control-room-backend
    environment:
      # Server configuration
      - NODE_ENV=production
      - PORT=3001
      - LOG_LEVEL=info

      # Jules AI service integration
      - JULES_API_KEY=${JULES_API_KEY:-change-me}

      # Local authentication
      - LOCAL_TOKEN=${LOCAL_TOKEN:-replace-in-prod}
      - ALLOWLIST=${ALLOWLIST:-}
      - CORS_ORIGIN=${CORS_ORIGIN:-}

      # LLM Router integration (when available)
      # Points to centralized router service for agentic features
      - LLM_ROUTER_URL=${LLM_ROUTER_URL:-http://llm-router:3000}

      # Feature flags for agentic capabilities
      - ENABLE_DASHBOARD_ASSISTANT=${ENABLE_DASHBOARD_ASSISTANT:-false}
      - ENABLE_SESSION_SUMMARIES=${ENABLE_SESSION_SUMMARIES:-false}
    ports:
      - "3001:3001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3001/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    volumes:
      - ./shared:/app/shared:ro
      - ./backend/public:/app/backend/public:ro
      - ./data:/app/data
    networks:
      - mcp-network
    # Uncomment when LLM router is deployed
    # depends_on:
    #   llm-router:
    #     condition: service_healthy

  # LLM Router Service (centralized)
  # Uncomment when router is built and ready to deploy
  #
  # llm-router:
  #   image: llm-router:latest
  #   build:
  #     context: ../llm-router
  #     dockerfile: Dockerfile
  #   container_name: llm-router
  #   environment:
  #     - NODE_ENV=production
  #     - PORT=3000
  #     - LOG_LEVEL=info
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #     - DEFAULT_MODEL=claude-3-5-sonnet-20241022
  #   ports:
  #     - "3000:3000"
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s
  #   networks:
  #     - mcp-network

volumes:
  data:
